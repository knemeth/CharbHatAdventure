# npc.hss

plotscript, charvile, begin
    variable()

    setTag(tag:charvileStart, on)
    controlsSuspended := true

    toggleCutsceneBars(true)

    focusCamera(84, 68, 2)
    waitForCamera()

    setHeroPosition(me, 79, 78)
    putSliceSubpixel(player, heroPixelX(me)*1000, heroPixelY(me)*1000)

    showTextbox(17)
    waitForTextbox()

    variable(ref, sl, spr)
    ref := globalNPCReference(enemy:charvile, 0)
    sl := getNPCSlice(ref)
    spr := lookupSlice(sl:walkaboutSpriteComponent, sl)

    setSliceVisible(sl, true)
    dissolveSprite(spr, dissolve:melt, 120, 0, true)
    waitForDissolve(spr)
    wait(4)
    charvileUndulate()
    suspendObstruction()
    walkNPC(ref, down, 9)
    focusCamera(84, 78, 1)


    showTextbox(6)
    waitForTextbox()

    wait(10)

    variable(x, y)
    for(x, 0, mapWidth()--1) do(
        for(y, 0, mapHeight()--1) do(
            if(readZone(1, x, y)) then(
                writePassBlock(x, y, northwall+southwall+eastwall+westwall)
                writeMapBlock(x, y, 133, 1)
            )
        )
    )

    toggleCutsceneBars(false)
    cameraFollowsHero(me)
    controlsSuspended := false
    setEnemyActDelay(globalNPCReference(enemy:charvile), 30)
    setEnemyState(globalNPCReference(enemy:charvile), state:idle)
    resumeObstruction()
    playSong(1)
end

script, charvileUndulate, reverse=false, begin
    variable(tick)
    if(reverse) then(tick := 180) 
    else(tick := 0)
    dissolveSprite(getNPCSprite(globalNPCReference(enemy:charvile)), dissolve:melt, 240, tick, reverse)
    setTimer(timer:charvileUndulate, 60, 1, @charvileUndulate)
    setTimerArgs(timer:charvileUndulate, (reverse+1),mod,2)
end